'use strict'
var Map = require("harmony-collections").Map;
var Set = require("harmony-collections").Set;
var parse = require('parse-svg-path');

var range = require('./utilities.js').range;

var Point = require('./point.js');

var random = Math.random;

var nbRandomPoints = 60;
var nbStartPoints = 20;

var nbCity = 2;

var textMesh = true;

// Frame definition
var xInit = 0, yInit = 0;
var w = 1,
    h = 1;


// var svgString = "m 1028.3224,362.79152 c -16.6587,-2.34387 -33.35995,-6.23515 -49.25137,-12.08831 -15.89142,-5.85316 -30.97305,-13.6682 -44.3926,-23.85957 3.73715,-8.02639 7.96065,-15.79371 12.19101,-23.55228 4.23037,-7.75858 8.46759,-15.50842 12.23219,-23.49984 8.82902,6.69162 18.48235,12.75663 28.67412,17.86344 10.19178,5.10681 20.92205,9.25542 31.90485,12.11421 10.9829,2.8588 22.2183,4.4278 33.4206,4.37539 11.2022,-0.0524 22.3713,-1.72622 33.2212,-5.35304 14.2804,-6.92169 17.3033,-19.64436 13.4946,-31.15028 -3.8087,-11.50591 -14.4489,-21.79507 -27.4946,-23.84972 -10.162,-4.07686 -21.1052,-7.14863 -32.1975,-10.11097 -11.0924,-2.96235 -22.334,-5.81526 -33.0931,-9.45439 -10.7591,-3.63914 -21.03562,-8.06449 -30.19779,-14.17171 -9.16216,-6.10723 -17.20996,-13.89632 -23.51158,-24.26293 -5.1794,-10.97058 -7.48544,-22.77583 -7.30512,-34.52966 0.18031,-11.75382 2.84698,-23.4562 7.61299,-34.22103 4.76601,-10.76483 11.63137,-20.5921 20.20905,-28.595692 8.57769,-8.003592 18.86771,-14.183506 30.48305,-17.653621 12.1821,-4.024145 24.8777,-6.357009 37.6988,-7.121901 12.8211,-0.764892 25.7677,0.03819 38.4517,2.285933 12.6841,2.247744 25.1055,5.940153 36.8765,10.953918 11.7709,5.013764 22.8912,11.348885 32.973,18.882053 -4.4745,7.00368 -8.2581,14.70708 -12.1886,22.23499 -3.9306,7.5279 -8.008,14.88031 -13.0701,21.18198 -15.0728,-11.15158 -33.5009,-20.54491 -52.6114,-24.91726 -19.1105,-4.37235 -38.9034,-3.72372 -56.7058,5.20861 -10.0321,7.02789 -13.3348,18.84695 -11.1561,29.53596 2.1787,10.68902 9.8387,20.24799 21.732,22.75572 10.1335,4.43307 21.0241,7.69407 32.1101,10.69023 11.0861,2.99616 22.3676,5.72747 33.283,9.10117 10.9155,3.3737 21.4648,7.38978 31.0865,12.95547 9.6217,5.56569 18.3157,12.68099 25.5204,22.25313 6.6301,9.71635 10.5587,20.88023 12.0064,32.41231 1.4476,11.53207 0.4142,23.43234 -2.8797,34.62146 -3.2939,11.18912 -8.8484,21.66709 -16.443,30.35457 -7.5946,8.68749 -17.2293,15.58449 -28.6837,19.61166 -13.0091,5.92928 -27.0197,8.63869 -41.2728,9.63608 -14.253,0.99738 -28.7484,0.28274 -42.7272,-0.63608 z m -927.99998,-4 c 4.6011,-11.71047 9.20835,-23.42006 13.8199,-35.12898 4.61156,-11.70892 9.22741,-23.41718 13.84573,-35.125 4.61831,-11.70782 9.23908,-23.41519 13.86046,-35.12233 4.62138,-11.70714 9.24336,-23.41406 13.86411,-35.12097 4.62074,-11.70691 9.24025,-23.41381 13.85667,-35.12092 4.61641,-11.70712 9.22974,-23.41444 13.83814,-35.12218 4.60839,-11.70775 9.21186,-23.41592 13.80854,-35.12474 4.59668,-11.70881 9.18658,-23.418277 13.76785,-35.128603 12.99923,-3.357855 24.30069,-6.821144 33.86893,-4.46411 9.56825,2.357035 17.40328,10.534393 23.46967,30.457833 4.17598,10.62114 8.36031,21.23882 12.54942,31.85453 4.1891,10.61571 8.38298,21.22943 12.57807,31.84266 4.19509,10.61323 8.3914,21.22595 12.58535,31.83965 4.19395,10.61369 8.38555,21.22836 12.57123,31.84549 4.18568,10.61712 8.36544,21.2367 12.53572,31.86021 4.17028,10.6235 8.33108,21.25093 12.47883,31.88377 4.14775,10.63283 8.28245,21.27107 12.40053,31.9162 4.11808,10.64512 8.21955,21.29712 12.30085,31.95749 -5.90896,6.95561 -24.61617,1.11298 -35.59372,3 -16.75248,2.84859 -26.96421,-0.41416 -28.40628,-19 -3.17726,-8.42157 -6.35606,-16.87924 -9.47997,-25.34854 -3.12391,-8.46929 -6.19293,-16.9502 -9.15062,-25.41826 -16.46723,-0.80053 -35.17768,-2.74281 -53.33727,-3.11439 -18.1596,-0.37158 -35.76834,0.82753 -50.03214,6.30976 -4.15679,10.93124 -8.13806,21.9269 -12.15785,32.90546 -4.0198,10.97855 -8.07813,21.94001 -12.38903,32.80282 -9.52758,0.82747 -19.10457,0.96423 -28.69282,0.93363 -9.58824,-0.0306 -19.18773,-0.22855 -28.7603,-0.0705 l 0,-2.19791 z m 174,-109 c -3.17462,-9.51136 -6.44835,-18.99174 -9.7543,-28.46224 -6.81559,-19.51412 -6.24202,-25.37946 -12.3174,-43.60788 -3.16722,-9.51543 -13.60257,-32.32866 -16.49973,-41.92988 -6.08989,12.88576 -11.132,26.59272 -15.93415,40.47476 -4.80215,13.88203 -9.36435,27.93915 -14.49442,41.52524 -2.39425,12.05801 -22.8815,40.11116 2.18745,34 11.05256,-0.44486 22.52939,0.11061 33.85624,0.24955 11.32684,0.13895 22.50369,-0.13863 32.95631,-2.24955 z m 126,-31 c 0,0 0,-23.83334 0,-35.75 0,-11.91667 0,-23.83334 0,-35.75 0,-11.91666 0,-23.83333 0,-35.75 0,-11.916667 0,-23.833335 0,-35.750003 14.64729,1.05313 31.03193,-2.08808 44.60679,1.55415 6.18076,7.610996 12.35438,15.231342 18.51973,22.861013 6.16535,7.62967 12.32244,15.26866 18.47014,22.91696 6.1477,7.64829 12.28602,15.30588 18.41383,22.97274 6.12781,7.66686 12.24512,15.343 18.35081,23.02838 6.10568,7.68538 12.19975,15.38001 18.28107,23.08386 6.08132,7.70384 12.1499,15.41691 18.20462,23.13918 6.05472,7.72226 12.09557,15.45372 18.12145,23.19435 6.02587,7.74063 12.03676,15.49043 18.03156,23.24937 0.4558,-15.4914 0.72655,-30.98725 0.88119,-46.48582 0.15464,-15.49858 0.19319,-30.99988 0.18458,-46.50218 -0.009,-15.5023 -0.0643,-31.0056 -0.0983,-46.50817 -0.034,-15.50258 -0.0461,-31.004432 0.0325,-46.503833 9.33333,0 18.66667,0 28,0 9.33333,0 18.66666,0 28,0 0,11.916667 0,23.833332 0,35.750003 0,11.91666 0,23.83333 0,35.75 0,11.91666 0,23.83333 0,35.75 0,11.91667 0,23.83333 0,35.75 0,11.91666 0,23.83333 0,35.75 0,11.91667 0,23.83334 0,35.75 0,11.91666 0,23.83333 0,35.75 0,11.91667 0,23.83334 0,35.75 -14.6441,-1.05348 -31.026,2.08847 -44.59764,-1.55416 -6.27247,-7.38037 -12.48436,-14.81692 -18.65123,-22.29507 -6.16688,-7.47815 -12.28873,-14.9979 -18.38111,-22.54465 -6.09238,-7.54675 -12.15528,-15.12051 -18.20425,-22.70667 -6.04896,-7.58617 -12.08399,-15.18476 -18.12063,-22.78116 -6.03664,-7.5964 -12.07489,-15.19062 -18.1303,-22.76807 -6.05541,-7.57745 -12.12797,-15.13813 -18.23323,-22.66744 -6.10526,-7.52932 -12.24322,-15.02727 -18.42942,-22.47926 -6.18619,-7.45199 -12.42063,-14.85803 -18.71886,-22.20352 -0.22791,15.16496 -0.36674,30.3308 -0.4489,45.49718 -0.0822,15.16637 -0.10766,30.33329 -0.10889,45.5004 -0.001,15.16712 0.0218,30.33443 0.0367,45.50162 0.0149,15.16718 0.0216,30.33422 -0.0122,45.5008 -9.33333,0 -18.66667,0 -28,0 -9.33333,0 -18.66666,0 -28,0 0,-11.91667 0,-23.83334 0,-35.75 0,-11.91667 0,-23.83334 0,-35.75 0,-11.91666 0,-23.83333 0,-35.75 0,-11.91667 0,-35.75 -10e-6,-35.75 z m 376,24 c 0,-9.91667 0,-19.83334 0,-29.75 0,-9.91667 0,-19.83334 0,-29.75 0,-9.91666 0,-19.83333 0,-29.75 0,-9.91666 -1.47394,-19.83333 -1.47394,-29.75 0,-15.33334 -29.19273,0 -44.52606,0 -15.33333,0 -30.66667,0 -46,0 0,-8 0,-16 0,-24.000002 0,-8 0,-16.000001 0,-24.000001 9.91666,0 19.83333,0 29.75,0 9.91667,0 19.83333,0 29.75,0 9.91666,0 19.83333,0 29.75,0 9.91667,0 19.83333,0 29.75,0 9.91666,0 19.83333,0 29.75,0 9.91667,0 19.83333,0 29.75,0 9.91666,0 19.83333,0 29.75,0 9.91667,0 19.83333,0 29.75,0 0,8 0,16.000001 0,24.000001 0,8.000002 0,16.000002 0,24.000002 -15,0 -30,0 -45,0 -15,0 -44.88809,-13.52565 -45,1.47394 -0.0735,9.85588 -0.10613,18.2399 -0.11249,28.09923 -0.006,9.85932 0.0135,19.72001 0.045,29.58133 0.0315,9.86132 0.0745,19.72329 0.1143,29.58517 0.0399,9.86188 0.0765,19.72367 0.0954,29.58467 0.0189,9.86099 0.0199,19.72118 -0.0117,29.57984 -0.0315,9.85866 -0.0956,19.7158 -0.20688,29.57069 -0.11131,9.85488 -0.26985,19.70752 -0.49033,29.55719 -0.22047,9.84967 -0.50289,19.69636 -0.86193,29.53937 -7.39624,-0.99964 -18.95658,0.96726 -29.70912,1.82971 -10.75253,0.86245 -24.48556,2.02609 -24.86231,-4.79696 -0.66223,-11.99314 -0.66223,-21.54349 -0.49667,-30.48314 0.16556,-8.93965 0.49667,-17.2686 0.49667,-26.81895 0,-9.55035 0,-19.1007 0,-28.65105 0,-9.55035 0,-19.10069 0,-28.65104 z";
var svgString = "m 1246.3864,422.67046 c -32.6566,-3.05977 -80.9202,-1.60892 -64,-49.23572 -1.4759,-17.26999 -2.9389,-34.52697 19.6179,-27.76428 28.2051,-7.71782 5.6299,36.53428 29.3821,44 15.6401,11.08789 36.8268,15.16788 55.7601,11.43591 18.9333,-3.73198 35.6132,-15.27593 42.2399,-35.43591 11.114,-30.53447 -5.455,-63.66997 -34.7792,-76 -21.2379,-12.18874 -45.1963,-24.31647 -65.5186,-39.83315 -20.3223,-15.51668 -37.0085,-34.42231 -43.7022,-60.16685 -5.2777,-23.82651 1.2957,-47.48151 15.0269,-66.10238 13.7312,-18.62088 34.6201,-32.207623 57.9731,-35.897619 19.5714,-4.408067 39.5199,-4.455217 59.3132,-2.055584 19.7933,2.399634 39.4313,7.246051 58.3817,12.62512 1.5096,19.173023 5.7329,49.670133 -0.3128,65.430463 -16.657,-0.26915 -39.1842,5.88414 -31.6548,-19 -1.6482,-23.82053 -21.3427,-36.82701 -42.4938,-38.50012 -21.1511,-1.67312 -43.7588,7.98715 -51.2335,29.50012 -14.1826,27.84603 4.1914,57.9202 30,70 19.9649,13.49423 43.5526,24.76438 64.3552,38.77589 20.8027,14.01152 38.8202,30.7644 47.6448,55.22411 8.8577,24.73667 4.7321,50.90082 -7.7951,72.42372 -12.5272,21.5229 -33.456,38.40456 -58.2049,44.57628 -25.5516,8.81359 -53.4285,7.61391 -80,6 z m -502.75004,-4.49583 c -14.49634,-20.16798 -29.05177,-40.31989 -43.66494,-60.44416 -14.61316,-20.12428 -29.28404,-40.22091 -44.01126,-60.27834 -14.72723,-20.05744 -29.51079,-40.07567 -44.34931,-60.04313 -14.83851,-19.96747 -29.73199,-39.88417 -44.67904,-59.73854 0.085,67.94114 -2.59454,136.28635 1.45455,204 2.37361,21.33297 41.95968,2.60802 32,29.23572 -5.68484,10.73778 -30.97918,1.86608 -44.5036,4.76428 -19.16547,0 -38.33093,0 -57.4964,0 -12.17745,-31.99983 32.34126,-11.09351 34,-38 0.9227,-19.95147 1.50618,-39.93087 1.84747,-59.92634 0.34129,-19.99547 0.44039,-40.00702 0.39435,-60.02281 -0.0461,-20.01579 -0.23725,-40.03582 -0.47657,-60.04824 -0.23931,-20.01242 -0.52674,-40.01724 -0.76525,-60.00261 10.20299,-32.81396 -63.88039,-18.66932 -25.06566,-45.731739 23.84724,1.313312 50.33669,-2.975416 73.00768,1.582846 14.56739,20.242453 29.23861,40.419643 43.95531,60.568633 14.71671,20.14899 29.47889,40.26977 44.2282,60.39943 14.74931,20.12965 29.48574,40.26817 44.15094,60.45262 14.66519,20.18445 29.25916,40.41483 43.72353,60.72821 0.83332,-70.07002 2.82145,-140.78692 -1,-210.54546 -10.39601,-9.71246 -51.54014,-21.85965 -24.14642,-33.454539 30.9003,0.49167 61.92696,-1.293841 92.71785,1.42857 12.44918,33.638319 -51.66003,12.223739 -34.00692,55.415179 -0.24121,22.59532 -0.38824,45.19117 -0.47532,67.78734 -0.0871,22.59618 -0.11419,45.19267 -0.11559,67.7893 -10e-4,22.59662 0.0229,45.19336 0.0387,67.79003 0.0158,22.59667 0.0231,45.19326 -0.0123,67.78958 -15.5356,-0.53883 -31.43722,1.23098 -46.75,-1.49583 z M 132.38637,405.67046 c -2.30195,-19.38098 35.20853,-6.01885 35.99999,-32 10.6943,-23.20341 21.35806,-46.41833 32.00899,-69.63818 10.65093,-23.21985 21.28905,-46.44461 31.93207,-69.6677 10.64303,-23.22308 21.29096,-46.44449 31.96154,-69.65761 10.67058,-23.21313 21.3638,-46.41797 32.0974,-69.607939 14.00633,-14.784664 31.06301,-3.589508 34,14.571429 9.47589,20.50998 18.90267,41.04032 28.32168,61.57386 9.41901,20.53355 18.83027,41.07031 28.27512,61.59315 9.44485,20.52284 18.92331,41.03177 28.47672,61.50964 9.55341,20.47788 19.18179,40.9247 28.92648,61.32335 8.94847,18.57494 17.97684,44.59976 44,40 6.95283,23.21831 -11.22619,21.30477 -28.79645,20 -17.53393,0 -35.06785,0 -52.60178,0 -17.53392,0 -35.06785,0 -52.60177,0 -13.61053,-31.56953 34.86478,-11.43099 30,-37 -7.96326,-20.44937 -16.90067,-40.88219 -27.17188,-60.1481 -22.69835,-0.30159 -45.74783,-1.00478 -68.70149,-1.13746 -22.95367,-0.13269 -45.81153,0.30513 -68.12663,2.28556 -10.15614,23.48394 -27.65652,46.62921 -26.57143,72.57143 21.87983,-9.59529 37.44237,23.82765 14.09999,23.42857 -25.17618,0 -50.35237,0 -75.52855,0 0,-3.33333 0,-6.66667 0,-10 z m 213.99999,-112 c -9.85189,-19.92913 -19.12968,-40.10864 -28.4649,-60.26037 -9.33521,-20.15173 -18.72785,-40.27567 -28.8094,-60.09366 -8.0471,4.62582 -13.12108,26.97607 -19.7257,38.35403 -12.60829,27.21944 -25.26661,54.41816 -37,82 18.19346,1.65846 37.60009,2.48757 57.00505,2.48751 19.40495,-6e-5 38.80822,-0.82929 56.99495,-2.48751 z m 582,112 c -1.2337,-21.88184 52.78642,-3.94103 39.43532,-42.15625 0.24195,-20.8192 0.38925,-41.63897 0.47635,-62.45909 0.0871,-20.82012 0.11398,-41.64058 0.1151,-62.46118 10e-4,-20.8206 -0.0235,-41.64134 -0.0394,-62.46199 -0.0159,-20.82065 -0.0232,-41.64122 0.0127,-62.46149 -26.37832,2.29828 -55.93232,-6.20371 -79.85787,6.80589 -1.50256,28.04473 -4.68344,46.64651 -35.23142,39.19411 -7.11643,-15.54116 -0.90104,-46.83584 -1.48214,-66.571429 25.02495,-0.70812 50.0617,-1.115779 75.10565,-1.337873 25.04395,-0.222093 50.0951,-0.258621 75.14885,-0.224476 25.0538,0.03414 50.1101,0.138961 75.1645,0.199555 25.0544,0.06059 50.1067,0.07697 75.1525,-0.06578 0,22.666673 0,45.333333 0,68.000003 -11.5708,-3.09584 -38.1128,8.77945 -32,-12 6.3763,-41.53883 -40.2943,-34.36261 -67.7072,-34 -23.6002,-7.69784 -14.9407,16.86409 -16.2929,31.41431 0.1745,19.75739 0.1467,39.53024 0.067,59.30763 -0.08,19.77738 -0.2116,39.5593 -0.2452,59.33481 -0.034,19.77551 0.031,39.54462 0.3439,59.29638 0.3129,19.75176 0.8743,39.48618 1.8343,59.19232 6.3204,22.76756 50.3983,0.0574 38.0001,33.45455 -24.6667,0 -49.3333,0 -74,0 -24.66671,0 -49.3334,0 -74.00007,0 0,-3.33333 0,-6.66667 0,-10 z";
//var svgString = "m 979.07103,350.70321 c -15.89142,-5.85316 -30.97305,-13.6682 -44.3926,-23.85957 7.75724,-16.48178 17.17978,-31.76383 24.4232,-47.05212 18.77991,13.88496 39.5498,24.40529 60.57897,29.97765 22.5636,5.61935 46.1724,5.71757 66.6418,-0.97765 14.2804,-6.92169 17.3033,-19.64436 13.4946,-31.15028 -11.7972,-24.44285 -37.4528,-28.00725 -59.6921,-33.96069 -11.0924,-2.96235 -22.334,-5.81526 -33.0931,-9.45439 -22.07499,-7.35217 -42.44565,-20.26865 -53.70937,-38.43464 -9.83657,-23.38973 -9.02665,-47.23528 0.30787,-68.75069 10.90238,-22.52727 28.46583,-39.383207 50.6921,-46.249313 12.1821,-4.024145 24.8777,-6.357009 37.6988,-7.121901 26.5465,-1.202199 52.5846,3.66994 75.3282,13.239851 11.7709,5.013764 22.8912,11.348885 32.973,18.882053 -9.2264,14.54878 -15.2348,30.77003 -25.2587,43.41697 -15.0728,-11.15158 -33.5009,-20.54491 -52.6114,-24.91726 -19.1105,-4.37235 -38.9034,-3.72372 -56.7058,5.20861 -10.0321,7.02789 -13.3348,18.84695 -11.1561,29.53596 8.2669,24.19706 33.1702,27.83391 53.8421,33.44595 22.4826,6.12582 45.4171,11.24681 64.3695,22.05664 21.7523,13.46401 34.3101,30.65145 37.5268,54.66544 2.1004,24.34461 -4.4723,47.67975 -19.3227,64.97603 -18.9396,19.68039 -45.1963,27.39692 -69.9565,29.24774 -31.8701,2.17304 -64.224,-2.65054 -91.97857,-12.72439 z m -878.74861,8.08831 c 36.79582,-93.72853 76.99672,-195.03913 110.6614,-280.993723 12.99923,-3.357855 36.09221,-2.399326 45.66045,-0.04229 33.60115,76.567143 80.36216,199.341173 111.67815,281.036013 -22.70615,10.93611 -53.29916,19.07137 -55.15636,0.21333 -6.55202,-17.37997 -21.76816,-50.66545 -27.47423,-66.98013 -33.61042,-1.14101 -73.27543,-7.93663 -103.36941,3.19537 -8.53979,22.52579 -16.30488,44.88745 -24.54688,65.70828 -19.70144,1.60407 -39.10379,0.58497 -57.45312,0.86313 l 0,-2.19791 z m 174,-109 c -11.28546,-39.41028 -28.29031,-81.92753 -38.57143,-114 -13.40959,33.30997 -53.42765,116.91851 -35.61082,114.52606 22.87389,-0.92513 53.06087,3.59108 74.18225,-0.52606 z m 126,-174.000003 c 14.64729,1.05313 31.03193,-2.08808 44.60679,1.55415 54.43659,67.452473 98.13155,121.991023 146.39321,184.445853 1.80482,-63.02795 0.70441,-125.10223 0.99997,-186.000003 19.2332,0 38.12247,0 56,0 0,96.143823 0,191.483173 0,286.000003 -14.6441,-1.05348 -31.026,2.08847 -44.59764,-1.55416 -51.45123,-60.69006 -96.46209,-121.61641 -146.86903,-180.44584 -0.90366,61.68318 -0.40641,122.41241 -0.53329,182 -9.33333,0 -18.66667,0 -28,0 -9.33333,0 -18.66666,0 -28,0 0,-93.41696 -10e-6,-193.61517 -10e-6,-286.000003 z m 374.52606,48.000003 c -19.88686,-11.19703 -65.34503,0 -90.52606,0 0,-16.4856 0,-32.6764 0,-48.000003 80.0078,0 159.34614,0 238,0 0,16.485599 0,32.676403 0,48.000003 -23.52292,2.9447 -89.16068,-8.36216 -90,1.47394 -0.54085,78.58227 1.38039,157.45947 -1.42863,235.09749 -11.93418,-1.67345 -53.14305,7.8044 -54.57143,-2.96725 1.103,-78.58465 -1.06452,-156.29105 -1.47388,-233.60418 z"
//var svgString = "m 376,24 c 0,-19.83334 0,-39.66667 0,-59.5 0,-19.83333 0,-39.66666 0,-59.5 -15.33334,0 -30.66667,0 -46,0 -15.33333,0 -30.66667,0 -46,0 0,-16 0,-32.000003 0,-48.000003 19.83333,0 39.66667,0 59.5,0 19.83333,0 39.66667,0 59.5,0 19.83333,0 39.66667,0 59.5,0 19.83333,0 39.66667,0 59.5,0 0,16 0,32.000003 0,48.000003 -15,0 -30,0 -45,0 -15,0 -30,0 -45,0 -0.14707,19.71176 -0.13037,39.43185 -0.0675,59.1545 0.0629,19.72265 0.17199,39.44785 0.20971,59.16984 0.0377,19.72199 0.004,39.44075 -0.21855,59.15053 -0.22261,19.70977 -0.63417,39.41055 -1.35226,59.09656 -14.79248,-1.99928 -46.24135,7.86759 -54.57143,-2.96725 0,-19.1007 0,-38.20139 0,-57.30209 0,-19.1007 0,-38.2014 0,-57.30209 z"

 
function svgToPoints(svgString) {
    var points = [];
    //var edges = [];

    var edges = new Map(); // pointId -> pointId on border
    var beginingPath;

    var X = 0;
    var Y = 0;
    var nbPoints = 0;
    var prevPoint;

    var commands = parse(svgString)
    for (var i=0; i<commands.length; i++){
        var command = commands[i];
        switch (command[0]) {
            case "m":
                X += command[1];
                Y += command[2];
                prevPoint = undefined;
                beginingPath = nbPoints;
                break;
            case "M":
                X = command[1];
                Y = command[2];
                prevPoint = undefined;
                beginingPath = nbPoints;
                break;  
            case "c":
                X += command[5];
                Y += command[6];
                points.push({id:nbPoints, x:X, y:Y});
                // nbPoints++;
                // if (prevPoint) {
                //     edges.push([prevPoint, nbPoints]);
                //     prevPoint = nbPoints;
                // }
                if (prevPoint != undefined) {
                    edges.set(prevPoint, nbPoints);
                }
                prevPoint = nbPoints;
                nbPoints++;
                break;
            case "z":
                edges.set(prevPoint, beginingPath);
                beginingPath = undefined;
                prevPoint = undefined;
                break;    
        }
    }
    return {points : points, edges : edges};
}

// initialize points
var points = [];
var forcedEdges;
var citySet;

if (textMesh){

    var myText = svgToPoints(svgString);
    points = myText.points;
    forcedEdges = myText.edges;
    citySet = new Set(range(0, points.length));

    var scaleX = 0.4;
    var scaleY = 0.2;

    // scale points to [0,1] + scale
    var maxX = Math.max.apply(Math, points.map(function(p){return p.x}));
    var minX = Math.min.apply(Math, points.map(function(p){return p.x}));
    var maxY = Math.max.apply(Math, points.map(function(p){return p.y}));
    var minY = Math.min.apply(Math, points.map(function(p){return p.y}));
    points = points.map(function(p){
        var x = scaleX * (p.x-minX)/(maxX-minX)+0.25;
        var y = scaleY * (p.y-minY)/(maxY-minY)+0.25;
        var newPoint = new Point(x, y);
        newPoint.id = p.id;

        return newPoint;
    });

    // only add random points
    var nbPoints = points.length;
    for(var i=0; i<nbRandomPoints; ++i) {

        //var x = random() * w + xInit;
        //var y = random() * h + yInit;

        var x = random();
        var y = random();

        var newPoint = new Point(x, y);
        newPoint.id = nbPoints;

        points.push(newPoint);

        nbPoints++;
    }

} else {
    //add random points

    var nbPoints = 0;
    for(var i=0; i<nbRandomPoints; ++i) {

        var x = random();
        var y = random();

        var newPoint = new Point(x, y);
        newPoint.id = nbPoints;

        points.push(newPoint);
        
        nbPoints++;
    }

    citySet = new Set(range(0, nbCity));
}


// initialize start points
var possibleStartPointsId = [];

for (var i = 0; i < nbStartPoints; i++)
{
    possibleStartPointsId.push(Math.floor(nbRandomPoints * random()));
}



module.exports = {
    textMesh: textMesh,
    points: points,
    citySet: citySet,
    possibleStartPointsId: possibleStartPointsId,
    nbRandomPoints: nbRandomPoints,
    forcedEdges: forcedEdges
}